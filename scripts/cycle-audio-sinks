#! /usr/bin/env nu

let audio_status = wpctl status | split row -r "(?m)^Audio$" | get 1 | split row -r "(?m)^Video$" | get 0
let sinks = $audio_status | split row -r "(?m)Sinks:$" | get 1 | split row -r "(?m)^[^\\w\\d]+$" | get 0
let sinks = $sinks | lines | parse --regex '.*?(?P<is_default>\*?)\s+?(?P<id>\d+)\. (?P<name>.+?)\s+\[vol: (?P<volume>[.\d]+)\]'
let sinks = $sinks | update is_default { |sink| $sink.is_default == "*" }

mut next_sink = $sinks | first

let first_sink = $sinks | first
let remaining_sinks = $sinks | skip until {|sink| $sink.is_default } | skip 1

let next_sink = if ($remaining_sinks | is-not-empty) {
    $remaining_sinks | first
} else {
    $first_sink
}

wpctl set-default $next_sink.id
